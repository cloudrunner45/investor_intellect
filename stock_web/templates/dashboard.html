{% extends "base.html" %}

{% block head %}
    <link rel="stylesheet" href="{{ url_for('static', filename='dashboard.css') }}">
    <script>var stock_api_key = "{{ stock_api_key }}"</script>
{% endblock head %}

{% block content %}
<div class="container">
  <div class="row g-3">
    <div class="col-md-4">
      <div id="stock_input" class="section-card">
        <input type="text" id="ticker_name" class="form-control" placeholder="Search Ticker" oninput="start_display_ticker_list()">
        <div id="stock_load" class="list-group"></div>
      </div>
      <div id="watchlist" class="section-card mt-3 list-group">
        <h5 class="mb-2">Watchlist</h5>
      </div>
    </div>
    <div class="col-md-4">
      <div id="basic_ticker_info" class="section-card"></div>
      <div id="stock_info" class="section-card mt-3">
        <p id="stock_gen_info"></p>
      </div>
    </div>
    <div class="col-md-4">
      <div id="add_to_watchlist_logout" class="section-card">
        <input type="button" id="add_watchlist" class="btn btn-primary btn-sm" value="Add to Watchlist" onclick="add_to_watchlist()">
        <input type="button" id="remove_watchlist" class="btn btn-outline-secondary btn-sm" value="Remove from Watchlist" onclick="remove_from_watchlist()">
      </div>
      <div id="master_div" class="section-card mt-3">
        <div id="gen_select" class="mb-2">
          <button type="button" class="btn btn-light btn-sm" onclick="show_news(); get_news_input()">News</button>
          <button type="button" class="btn btn-light btn-sm" onclick="show_notes(); Data_for_display_notes()">Notes</button>
          <button type="button" class="btn btn-light btn-sm" onclick="show_stock_data(); get_data_stock_info()">Stock Info</button>
        </div>
        <div id="news"></div>
        <div id="ticker_notes">
          <label for="note_input">Note Content:</label>
          <textarea id="note_input" name="note_input" rows="8" class="form-control" oninput="save_note()"></textarea>
        </div>
        <div id="stock_data">
          <p id="asset_type"></p>
          <p id="market_cap"></p>
          <p id="DiviPerShare"></p>
          <p id="pe"></p>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
function show_news(){
    $("#news").show()
    $("#ticker_notes").hide()
    $("#stock_data").hide()
}
function show_notes(){
    $("#ticker_notes").show()
    $("#news").hide()
    $("#stock_data").hide()
}
function show_stock_data(){
    $("#stock_data").show()
    $("#news").hide()
    $("#ticker_notes").hide()
}
function show_watchlist_button(status){
    if(status == true){
        $("#add_watchlist").hide()
        $("#remove_watchlist").show()
    } else {
        $("#remove_watchlist").hide()
        $("#add_watchlist").show()
    }
}

function retrive_basic_info(){
    ticker = "{{ stock }}"
    $.ajax({
        url: `https://www.alphavantage.co/query?function=GLOBAL_QUOTE&symbol=${ticker}&apikey=${stock_api_key}`,
        method: 'GET',
        success: function(data) {
            display_info(data['Global Quote'])
        },
        error: function(error) {
            console.error('Error:', error);
        }
    })
}
function display_info(data){
    let sym = data["01. symbol"]
    let price = data["05. price"]
    let change = data["10. change percent"]
    $("#basic_ticker_info").html(`<span>Ticker: ${sym}</span><br> <span>Price: ${price}</span><br> <span>Change: ${change}</span>`)
}

function start_display_ticker_list(){
    var enteredValue = document.getElementById('ticker_name').value
    $.ajax({
        url: `https://www.alphavantage.co/query?function=SYMBOL_SEARCH&keywords=${enteredValue}&apikey=${stock_api_key}`,
        method: 'GET',
        success: function(data) {
            display_tickers(data['bestMatches']);
        },
        error: function(error) {
            console.error('Error:', error);
        }
    });
}
function display_tickers(data){
    $("#stock_load").empty();
    for(stonk of data){
        let name = stonk["2. name"]
        let sym = stonk["1. symbol"]
        var flaskRouteURL = "{{ url_for('dashboard_stock',stock='' ) }}" + sym;
        $("#stock_load").append(`<a class="list-group-item list-group-item-action" href="${flaskRouteURL}">${name}</a>`);
    }
}

function add_to_watchlist(){
    const stonk_to_add = "{{ stock }}";
    send_Data_for_watchlist_db(stonk_to_add);
}
function send_Data_for_watchlist_db(data) {
    $.ajax({
        url: '/add_watchlist',
        type: 'POST',
        data: { 'data': data},
        success: function(response) {
            location.reload();
        },
        error: function(error) {
            console.log(error);
        }
    });
}
function get_watchlist_data_from_db(){
    $.ajax({
        url: '/display_watchlist',
        type: 'GET',
        success: function(data) {
            display_watchlist(data);
            current_ticker_in_watchlist(data)
        },
        error: function(xhr, status, error) {
            console.error('Error:', error);
        }
    });
}
function display_watchlist(data){
    for(ticker of data){
        var flaskRouteURL = "{{ url_for('dashboard_stock',stock='' ) }}" + ticker;
        $("#watchlist").append(`<a class="list-group-item" href="${flaskRouteURL}">${ticker}</a>`);
    }
}
function current_ticker_in_watchlist(data){
    const active_ticker = "{{ stock }}"
    const isInArray = data.includes(active_ticker);
    show_watchlist_button(isInArray)
}
function remove_from_watchlist(){
    const stonk_to_remove = "{{ stock }}";
    send_data_to_remove(stonk_to_remove);
}
function send_data_to_remove(data){
    $.ajax({
        url: '/remove_watchlist',
        type: 'POST',
        data: { 'data': data},
        success: function(response) {
            location.reload();
        },
        error: function(error) {
            console.log(error);
        }
    });
}

function save_note(){
    var get_note = document.getElementById("note_input").value;
    send_note(get_note)
}
function send_note(data){
    var user = "{{ current_user.id }}"
    var ticker = "{{ stock }}"
    $.ajax({
        url: '/get_note',
        type: 'POST',
        data: { 'data': data, 'user': user, 'ticker': ticker},
        success: function(response) {
        },
        error: function(error) {
            console.log(error);
        }
    });
}
function Data_for_display_notes() {
    var user = "{{current_user.id}}"
    var ticker = "{{ stock }}"
    $.ajax({
        url: '/display_note',
        type: 'POST',
        data: { 'user': user, 'ticker': ticker},
        success: function(response) {
            display_notes(response)
        },
        error: function(error) {
            console.log(error);
        }
    });
}
function display_notes(note){
    var textarea = document.getElementById("note_input");
    textarea.value = note;
}

function get_data_stock_info(){
    const ticker = "{{ stock }}"
    $.ajax({
        url: `https://www.alphavantage.co/query?function=OVERVIEW&symbol=${ticker}&apikey=${stock_api_key}`,
        method: 'GET',
        success: function(data) {
            display_analitics(data)
        },
        error: function(error) {
            console.error('Error:', error);
        }
    });
}
function display_analitics(data){
    let market_cap = data["MarketCapitalization"];
    let dividend = data["DividendPerShare"];
    let pe = data["PERatio"];
    let asset_type = data["AssetType"]
    document.getElementById("market_cap").innerHTML = `Market Cap: ${market_cap}`;
    document.getElementById("DiviPerShare").innerHTML = `Dividend Per Share: ${dividend}`;
    document.getElementById("pe").innerHTML = `PE Ratio: ${pe}`;
    document.getElementById("asset_type").innerHTML = `Asset Type: ${asset_type}`;
}
function dispaly_summury(){
    const ticker = "{{ stock }}"
    $.ajax({
        url: `https://www.alphavantage.co/query?function=OVERVIEW&symbol=${ticker}&apikey=${stock_api_key}`,
        method: 'GET',
        success: function(data) {
            dispaly_sum(data)
        },
        error: function(error) {
            console.error('Error:', error);
        }
    });
}
function dispaly_sum(data){
    let desc= data["Description"]
    if(desc == "None" || desc == null  ){
        document.getElementById("stock_gen_info").innerHTML = "";
    } else {
        document.getElementById("stock_gen_info").innerHTML = desc;
    }
}

function get_news_input(){
    var ticker = "{{stock}}"
    $.ajax({
        url: `https://www.alphavantage.co/query?function=NEWS_SENTIMENT&tickers=${ticker}&apikey=${stock_api_key}`,
        method: 'GET',
        success: function(data) {
            display_news(data['feed'])
        },
        error: function(error) {
            console.error('Error:', error);
        }
    });
}
function display_news(data_input){
    data = data_input
    const news_list = []
    for(let i = 0; i<20; ++i){
        let stonk_news = data[i]
        let title = stonk_news['title']
        let url = stonk_news['url']
        $("#news").append(`<a href="${url}">${title}</a><br>`)
    }
}

var stock_sym = "{{stock}}"
get_watchlist_data_from_db()
retrive_basic_info()
dispaly_summury()
show_stock_data()
get_data_stock_info()
</script>
{% endblock %}
